Based on the reasoning result, create an execution plan.

User Question: {{ user_question }}
Reasoning Result: {{ reasoning_result }}

User Profile:
{% if user_profile %}

Full Name: {{ user_profile.full_name or "Not provided" }}

Birthday: {{ user_profile.birthday or "Not provided" }}

Account Number: {{ user_profile.account_number or "Not provided" }}

Language: {{ user_profile.language or "Not provided" }}
{% else %}
No user profile available
{% endif %}

Available Tools:
{% if available_tools %}
{% for tool in available_tools %}

{{ tool }}
{% endfor %}
{% else %}
No tools available
{% endif %}

ROUTING INTENT (derive from Reasoning Result):

If asks about TBI/PPAI/indicators → intent="tbi"

If asks about trading/analysis/performance/history → intent="trading"

If asks about Lumir platform/features/how-to → intent="lumir"

If missing critical user inputs → intent="missing_inputs"

If multiple intents → handle in ordered steps by priority rules below

IMPORTANT – ONLY USE THESE ACTIONS:

"calculate_tbi_indicators" – for TBI questions and personal indicators

"get_trading_analysis" – for trading questions and historical analysis

"search_knowledge_base" – for general questions and information lookup

"direct_response" – ONLY when explicitly asking for missing user information

Do NOT invent any action outside the 4 above.

ACTION SELECTION PRIORITY:

FIRST: Validate required user profile fields

TBI: If intent="tbi" AND have full_name + birthday → use "calculate_tbi_indicators"

Trading: If intent="trading" AND have account_number or trading data → use "get_trading_analysis"

Lumir: If intent="lumir" → use "search_knowledge_base"

LAST RESORT: If required fields are missing → use "direct_response" to request only the missing fields

MISSING INPUTS RULE:

TBI requires: full_name (e.g., "Nguyễn Văn An", "John Smith") AND birthday in dd/mm/yyyy (e.g., "15/03/1990")

Trading requires: account_number OR explicitly provided trading metrics/data

ONLY choose "direct_response" when these are truly absent in user profile

EDGE CASES:

Multiple intents: create multiple steps in the plan following the priority order above

No available tools: fallback to "direct_response" describing what info or tool is missing

Non-trading/general Lumir questions: prefer "search_knowledge_base"

Language: respect {{ user_profile.language or "Not provided" }} when forming "direct_response" messages

TBI EXAMPLES:

"Tôi cần tính TBI. Tên tôi là Nguyễn Văn An, sinh ngày 15/03/1990" → "calculate_tbi_indicators"

"Calculate my TBI index. My name is John Smith, born 25/12/1985" → "calculate_tbi_indicators"

"Hãy tính lại chỉ số TBI của tôi" + profile có name & birthday → "calculate_tbi_indicators"

Return JSON only:
{
"goal": "main objective",
"steps": [
{
"step": "Step 1",
"reasoning": "why this step is needed",
"action": "MUST be one of: calculate_tbi_indicators, get_trading_analysis, search_knowledge_base, direct_response"
}
],
"tools_needed": ["tool1", "tool2"]
}